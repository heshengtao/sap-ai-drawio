<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<title>Live Draw.io Preview</title>
<style>
:root{
  --bg: #ffffff;
  --text: #333333;
  --font: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
}
html,body{
  padding:0;
  margin: 0;
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:var(--font);
  font-size:14px;
  display:flex;
  flex-direction:column;
  overflow: hidden;
}
main{
  flex:1;
  position: relative;
  width: 100%;
  height: 100%;
  background-color: #f0f0f0;
}
#preview-frame{
  width: 100%;
  height: 100%;
  border: none;
  display: block;
}
#loading-indicator {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(0, 123, 255, 0.9);
  color: white;
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 12px;
  z-index: 100;
  display: none;
  pointer-events: none;
}
</style>
</head>
<body>

<main id="container">
  <div id="loading-indicator">Rendering...</div>
  <iframe id="preview-frame"></iframe>
</main>

<script>
/* ========== 配置与状态 ========== */
const iframe = document.getElementById('preview-frame');
const loadingIndicator = document.getElementById('loading-indicator');
let currentXml = '';
let renderTimer = null;
let isIframeReady = false;

// 定义系统提示词
const SYSTEM_PROMPT = "你是一位经验丰富的原生drawio XML编写助手。请以下面的格式提供代码，所有代码都需要放在一个 XML 代码块中：\n```xml\n这里是 drawio XML 代码\n```";

// 【核心修改】使用纯文本 XML，避免 Zlib 解压报错
const BLANK_XML = `
<mxfile host="Embed">
  <diagram name="Page-1">
    <mxGraphModel dx="1000" dy="1000" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
`;

// 初始化 URL
const drawioUrl = 'https://embed.diagrams.net/?embed=1&ui=atlas&spin=1&modify=1&proto=json&noSaveBtn=1&libraries=1';

/* ========== XML 清洗与修复 ========== */

function sanitizeDrawioXml(xmlStr) {
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlStr, "application/xml");
    
    if (doc.querySelector('parsererror')) {
      return xmlStr;
    }

    // 修复 1: 移除会导致错误的 mxPoint
    const badPoints = doc.querySelectorAll('mxGeometry > mxPoint:not([as])');
    badPoints.forEach(el => el.parentNode.removeChild(el));

    // 修复 2: 清理非数字属性
    const geometryNodes = doc.querySelectorAll('mxGeometry');
    ['width', 'height', 'x', 'y'].forEach(attr => {
      geometryNodes.forEach(node => {
        if (node.hasAttribute(attr)) {
          let val = node.getAttribute(attr);
          if (/[^0-9\.\-]/.test(val)) {
            const num = val.replace(/[^0-9\.\-]/g, '');
            node.setAttribute(attr, num || (attr === 'x' || attr === 'y' ? '0' : '80'));
          }
        }
      });
    });

    return new XMLSerializer().serializeToString(doc);

  } catch (e) {
    console.warn('XML清洗失败:', e);
    return xmlStr;
  }
}

function isValidXml(xmlStr) {
  if (!xmlStr || xmlStr.length < 50) return false;
  // 必须包含关键标签
  if (!xmlStr.includes('<mxGraphModel') && !xmlStr.includes('<mxfile')) return false;
  // 必须闭合（简单判断）
  if (!xmlStr.includes('</mxfile>') && !xmlStr.includes('</mxGraphModel>')) return false;
  return true;
}

function extractDrawioXml(text) {
  if (!text) return { xml: '', isComplete: false };

  const roots = ['mxfile', 'mxGraphModel'];
  let startIndex = -1;
  let rootTag = '';

  for (const tag of roots) {
    const idx = text.indexOf('<' + tag);
    if (idx !== -1) {
      if (startIndex === -1 || idx < startIndex) {
        startIndex = idx;
        rootTag = tag;
      }
    }
  }

  if (startIndex === -1) return { xml: '', isComplete: false };

  let xmlContent = text.substring(startIndex);
  const endTag = `</${rootTag}>`;
  const endTagIndex = xmlContent.indexOf(endTag);
  let isComplete = false;

  if (endTagIndex !== -1) {
    xmlContent = xmlContent.substring(0, endTagIndex + endTag.length);
    isComplete = true;
  }

  if (isComplete) {
      xmlContent = sanitizeDrawioXml(xmlContent);
  }

  return { xml: xmlContent, isComplete: isComplete };
}

/* ========== 渲染逻辑 ========== */

function showLoading(show) {
  loadingIndicator.style.display = show ? 'block' : 'none';
}

function initIframe() {
  if (iframe.src === '' || iframe.src === 'about:blank') {
    iframe.src = drawioUrl;
  }
}

function loadDiagram(xml) {
  if (!isIframeReady) return;
  
  // 使用修正后的空 XML
  const xmlToLoad = xml || BLANK_XML;

  iframe.contentWindow.postMessage(JSON.stringify({
    action: 'load', 
    xml: xmlToLoad,
    autosave: false 
  }), '*');
  
  showLoading(false);
}

function debouncedRender(xmlData) {
  clearTimeout(renderTimer);
  
  if (!xmlData.xml) return;
  if (!isValidXml(xmlData.xml)) {
    if (xmlData.xml.length > 50) showLoading(true);
    return;
  }
  if (xmlData.xml === currentXml) return;

  renderTimer = setTimeout(() => {
    currentXml = xmlData.xml;
    
    if (!isIframeReady) {
      initIframe();
    } else {
      loadDiagram(xmlData.xml);
    }
  }, 100);
}

function renderPreview(list) {
  if (!list || !list.length) return;
  
  const assistantMessages = list.filter(m => m.role === 'assistant');
  if (!assistantMessages.length) return;
  
  const lastMessage = assistantMessages[assistantMessages.length - 1];
  const content = lastMessage.pure_content || lastMessage.content || '';
  
  const xmlData = extractDrawioXml(content);
  
  if (xmlData.xml) {
    debouncedRender(xmlData);
  }
}

/* ========== WebSocket与初始化 ========== */

window.addEventListener('message', function(event) {
  if (event.source !== iframe.contentWindow) return;
  try {
    const msg = JSON.parse(event.data);
    
    if (msg.event === 'init') {
      isIframeReady = true;
      // 这里的逻辑是：如果没有 currentXml (历史消息没提取到)，则加载 BLANK_XML
      loadDiagram(currentXml || BLANK_XML);
    }
  } catch (e) {}
});

let ws;
let reconnectAttempts = 0;

function init() {
  initIframe();
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  
  ws.onopen = () => {
    reconnectAttempts = 0;
    
    // [新增功能] 发送系统提示词
    console.log("Setting system prompt for Draw.io...");
    ws.send(JSON.stringify({
      type: 'set_system_prompt',
      data: {
        text: SYSTEM_PROMPT
      }
    }));

    // 获取历史消息
    ws.send(JSON.stringify({type:'get_messages'}));
  };
  
  ws.onmessage = e => {
    try {
      const data = JSON.parse(e.data);
      if (data.type === 'messages_update' || data.type === 'broadcast_messages') {
        renderPreview(data.data.messages);
      }
    } catch (error) {}
  };
  
  ws.onclose = () => {
     if (reconnectAttempts++ < 5) setTimeout(init, 1000 * reconnectAttempts);
  };
}

init();
</script>
</body>
</html>